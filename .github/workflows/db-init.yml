name: Post-Deploy DB Init

# Triggered by Vercel's deployment status webhook — fires when a deployment
# to the production environment succeeds. This ensures seed data (locations,
# activities, suitability rules, etc.) is synced to MongoDB after every deploy.
on:
  deployment_status:

permissions:
  contents: read

jobs:
  db-init:
    name: Sync database seed data
    # Only run when the production deployment succeeds
    if: >-
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.environment == 'Production'
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Validate DB_INIT_SECRET is configured
        env:
          DB_INIT_SECRET: ${{ secrets.DB_INIT_SECRET }}
        run: |
          if [ -z "$DB_INIT_SECRET" ]; then
            echo "::error::DB_INIT_SECRET is not set — add it as a repository secret"
            exit 1
          fi

      - name: Call db-init endpoint
        env:
          DEPLOY_URL: ${{ github.event.deployment_status.target_url }}
          DB_INIT_SECRET: ${{ secrets.DB_INIT_SECRET }}
        run: |
          # Validate DEPLOY_URL is a known Vercel preview or production domain
          # to prevent sending DB_INIT_SECRET to an unexpected environment.
          if [[ "$DEPLOY_URL" =~ ^https://(weather\.mukoko\.com|[a-z0-9-]+-nyuchitech\.vercel\.app)(/|$) ]]; then
            BASE_URL="$DEPLOY_URL"
          else
            echo "::warning::DEPLOY_URL '${DEPLOY_URL}' is not a recognised domain — falling back to production"
            BASE_URL="https://weather.mukoko.com"
          fi

          echo "Triggering db-init on ${BASE_URL}/api/db-init"

          # --retry-connrefused handles cold starts (no sleep needed)
          # --retry-delay 10 gives Vercel time to warm up between attempts
          # NOTE: curl --retry only retries on connection/network errors,
          # not HTTP 4xx/5xx responses. If db-init returns a 500 (e.g.
          # MongoDB cold start), curl will NOT retry it — the status
          # check below will report the failure instead.
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "x-init-secret: ${DB_INIT_SECRET}" \
            "${BASE_URL}/api/db-init" \
            --max-time 60 \
            --retry 5 --retry-delay 10 --retry-connrefused)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response (${HTTP_CODE}):"
          echo "$BODY" | head -20

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "db-init succeeded"
          else
            echo "::error::db-init failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
